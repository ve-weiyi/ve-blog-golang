# 服务部署说明

## 概述

本文档介绍 ve-blog-golang 项目的服务部署架构和部署方式。

**环境要求**：

- 开发环境：MySQL + Redis
- 生产环境：MySQL + Redis + RabbitMQ + Nacos + ETCD

## 服务架构

### 应用服务

| 服务名称      | 端口   | 用途       | 是否必需 | Dockerfile                                                  |
|-----------|------|----------|------|-------------------------------------------------------------|
| blog-rpc  | 8001 | RPC 服务   | 必需   | [Dockerfile-blog-rpc](../blog-gozero/Dockerfile-blog-rpc)   |
| blog-api  | 9090 | 博客前台 API | 必需   | [Dockerfile-blog-api](../blog-gozero/Dockerfile-blog-api)   |
| admin-api | 9091 | 管理后台 API | 必需   | [Dockerfile-admin-api](../blog-gozero/Dockerfile-admin-api) |

### 数据服务

| 服务名称          | 端口         | 用途     | 是否必需 | docker-compose                                                        |
|---------------|------------|--------|------|-----------------------------------------------------------------------|
| MySQL         | 3306       | 关系型数据库 | 必需   | [data/docker-compose.yaml](docker-compose/data/docker-compose.yaml)   |
| Redis         | 6379       | 缓存服务   | 必需   | [data/docker-compose.yaml](docker-compose/data/docker-compose.yaml)   |
| RabbitMQ      | 5672/15672 | 消息队列   | 推荐   | [data/docker-compose.yaml](docker-compose/data/docker-compose.yaml)   |
| Kafka         | 9092       | 消息队列   | 可选   | [kafka/docker-compose.yaml](docker-compose/kafka/docker-compose.yaml) |
| Elasticsearch | 9200       | 搜索引擎   | 可选   | 待实现                                                                   |

### 中间件服务

| 服务名称  | 端口   | 用途        | 是否必需 | docker-compose                                                        |
|-------|------|-----------|------|-----------------------------------------------------------------------|
| Nacos | 8848 | 配置中心/服务发现 | 生产必需 | [nacos/docker-compose.yaml](docker-compose/nacos/docker-compose.yaml) |
| ETCD  | 2379 | 服务注册发现    | 可选   | [etcd/docker-compose.yaml](docker-compose/etcd/docker-compose.yaml)   |

### DevOps 服务（可选）

| 服务名称    | 端口     | 用途    | 说明          |
|---------|--------|-------|-------------|
| GitLab  | 80/443 | 代码仓库  | 代码版本控制      |
| Jenkins | 8080   | CI/CD | 持续集成和部署     |
| Harbor  | 80/443 | 镜像仓库  | Docker 镜像管理 |
| Nginx   | 80/443 | 反向代理  | 负载均衡、SSL 证书 |

## 快速部署

### 1. 部署数据服务

```bash
# 启动 MySQL、Redis、RabbitMQ
cd deploy/docker-compose/data
docker-compose up -d

# 查看服务状态
docker-compose ps
```

### 2. 初始化数据库

```bash
# 导入数据库
mysql -h localhost -u root -p < blog-veweiyi-init.sql
mysql -h localhost -u root -p < blog-veweiyi-data.sql
```

### 3. 部署应用服务

**方式一：Docker Compose（推荐）**

```bash
# 构建并启动所有服务
cd deploy
docker-compose up -d

# 查看日志
docker-compose logs -f blog-rpc
docker-compose logs -f blog-api
```

**方式二：直接运行**

```bash
# 启动 RPC 服务
cd blog-gozero
make run-rpc

# 启动 API 服务（新终端）
make run-blog
make run-admin
```

### 4. 验证部署

```bash
# 检查服务健康状态
curl http://localhost:9090/blog-api/v1/version
curl http://localhost:9091/admin-api/v1/version

# 访问 Swagger 文档
# 博客前台：http://localhost:9090/blog-api/v1/swagger/index.html
# 管理后台：http://localhost:9091/admin-api/v1/swagger/index.html
```

## 生产环境部署

### 1. 部署 Nacos 配置中心

```bash
cd deploy/docker-compose/nacos
docker-compose up -d

# 访问 Nacos 控制台：http://localhost:8848/nacos
# 默认账号密码：nacos/nacos
```

### 2. 配置 Nacos

在 Nacos 控制台创建配置：

- Namespace: `prod`
- Data ID: `ve-blog-golang`
- Group: `blog`
- 配置内容：参考 `blog-gozero/service/api/blog/etc/blog-api.yaml`

### 3. 部署 ETCD（可选）

```bash
cd deploy/docker-compose/etcd
docker-compose up -d
```

### 4. 构建镜像

```bash
# 构建 RPC 服务镜像
cd blog-gozero
docker build -f Dockerfile-blog-rpc -t ve-blog-rpc:latest .

# 构建 API 服务镜像
docker build -f Dockerfile-blog-api -t ve-blog-api:latest .
docker build -f Dockerfile-admin-api -t ve-admin-api:latest .
```

### 5. 启动服务

```bash
# 使用 Nacos 配置启动
docker run -d --name blog-rpc \
  -e NACOS_HOST=nacos.example.com \
  -e NACOS_NAMESPACE=prod \
  ve-blog-rpc:latest

docker run -d --name blog-api \
  -p 9090:9090 \
  -e NACOS_HOST=nacos.example.com \
  -e NACOS_NAMESPACE=prod \
  ve-blog-api:latest
```

## 常用命令

```bash
# 查看所有服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f [service_name]

# 重启服务
docker-compose restart [service_name]

# 停止所有服务
docker-compose down

# 停止并删除数据卷
docker-compose down -v
```

## 部署要求

### 硬件要求

- CPU: 2 核心以上
- 内存: 4GB 以上
- 磁盘: 20GB 以上

### 软件要求

- Docker 20.10+
- Docker Compose 2.0+
- 操作系统: Linux/macOS/Windows

### 网络要求

- 服务器之间网络互通
- 开放必要的端口（3306、6379、8848 等）
- 建议使用内网环境部署

## 监控与日志

### 日志查看

```bash
# 查看应用日志
docker logs -f blog-rpc
docker logs -f blog-api

# 查看数据库日志
docker logs -f mysql
```

### 健康检查

```bash
# 检查服务健康状态
curl http://localhost:9090/blog-api/v1/version

# 检查 Docker 容器状态
docker ps
```

## 故障排查

### 服务无法启动

1. 检查端口是否被占用：`netstat -tunlp | grep [port]`
2. 检查配置文件是否正确
3. 查看服务日志：`docker logs [container_name]`

### 数据库连接失败

1. 检查 MySQL 服务是否启动：`docker ps | grep mysql`
2. 检查数据库连接配置
3. 测试数据库连接：`mysql -h localhost -u root -p`

### Redis 连接失败

1. 检查 Redis 服务是否启动：`docker ps | grep redis`
2. 测试 Redis 连接：`redis-cli ping`

## 注意事项

1. 生产环境必须修改默认密码（MySQL、Redis、Nacos 等）
2. 建议配置 SSL 证书，使用 HTTPS 访问
3. 定期备份数据库数据
4. 配置日志收集和监控告警
5. 使用 Nginx 作为反向代理，提供负载均衡和安全防护