# 生产环境服务部署

本文档介绍如何在生产环境中部署 ve-blog-golang 博客系统的各个服务。

## 前置准备

确保已完成以下准备工作：

- ✅ 服务器已购买并初始化
- ✅ Docker 和 Docker Compose 已安装
- ✅ 域名已注册并完成备案（国内服务器）
- ✅ SSL 证书已申请

## 部署架构

```
前端服务（9420, 9421）
       ↓
Nginx 反向代理（80, 443）
       ↓
API 服务（9090, 9091）
       ↓
RPC 服务（9999）
       ↓
基础服务（MySQL, Redis, RabbitMQ）
```

## 一、部署基础服务

### 1. 克隆项目

```bash
# 克隆项目
git clone https://github.com/ve-weiyi/ve-blog-golang.git

# 进入deploy/docker-compose目录
cd ve-blog-golang/deploy/docker-compose/data

# 运行docker-compose，部署基础依赖服务
docker-compose up -d
```

## 二、部署后端服务

### 1. 拉取服务镜像

```bash
# 拉取blog-rpc
docker pull ghcr.io/ve-weiyi/blog-rpc:latest

# 拉取blog-api
docker pull ghcr.io/ve-weiyi/blog-api:latest

# 拉取admin-api
docker pull ghcr.io/ve-weiyi/admin-api:latest
```

### 2. 运行服务容器

**启动 RPC 服务**

```bash
docker run -d \
  --name blog-rpc \
  --restart always \
  -p 9999:9999 \
  -v ./runtime:/app/runtime \
  ghcr.io/ve-weiyi/blog-rpc:latest \
  ./blog \
  -nacos-host "veweiyi.cn" \
  -nacos-port "8848" \
  -nacos-username "nacos" \
  -nacos-password "nacos" \
  -nacos-namespace "prod" \
  -nacos-group "veweiyi.cn" \
  -nacos-data-id "blog-rpc"
```

**启动博客前台 API**

```bash
docker run -d \
  --name blog-api \
  --restart always \
  -p 9090:9090 \
  -v ./runtime:/app/runtime \
  ghcr.io/ve-weiyi/blog-api:latest \
  ./blog \
  -nacos-host "veweiyi.cn" \
  -nacos-port "8848" \
  -nacos-username "nacos" \
  -nacos-password "nacos" \
  -nacos-namespace "prod" \
  -nacos-group "veweiyi.cn" \
  -nacos-data-id "blog-api"
```

**启动管理后台 API**

```bash
docker run -d \
  --name admin-api \
  --restart always \
  -p 9091:9091 \
  -v ./runtime:/app/runtime \
  ghcr.io/ve-weiyi/admin-api:latest \
  ./admin \
  -nacos-host "veweiyi.cn" \
  -nacos-port "8848" \
  -nacos-username "nacos" \
  -nacos-password "nacos" \
  -nacos-namespace "prod" \
  -nacos-group "veweiyi.cn" \
  -nacos-data-id "admin-api"
```

## 三、部署前端服务

### 1. 拉取前端镜像

```bash
docker pull ghcr.io/ve-weiyi/ve-blog-naive:latest

docker pull ghcr.io/ve-weiyi/ve-admin-element:latest
```

### 2. 运行前端容器

**启动博客前台**

```bash
docker run -d \
  --name ve-blog-naive \
  --restart always \
  -p 9420:80 \
  ghcr.io/ve-weiyi/ve-blog-naive:latest
```

**启动管理后台**

```bash
docker run -d \
  --name ve-admin-element \
  --restart always \
  -p 9421:80 \
  ghcr.io/ve-weiyi/ve-admin-element:latest
```

## 四、验证部署

### 1. 检查服务状态

```bash
# 查看所有容器状态
docker ps

# 查看服务日志
docker logs blog-rpc
docker logs blog-api
docker logs admin-api
```

### 2. 访问服务

将 `<your_server_ip>` 替换为你的服务器真实 IP 地址：

**前端服务**

- 博客前台：`http://<your_server_ip>:9420`
- 管理后台：`http://<your_server_ip>:9421`

**API 接口文档**

- 前台接口：`http://<your_server_ip>:9090/api/v1/swagger/index.html`
- 后台接口：`http://<your_server_ip>:9091/admin_api/v1/swagger/index.html`

## 五、服务管理

### 常用命令

```bash
# 停止服务
docker stop blog-rpc blog-api admin-api ve-blog-naive ve-admin-element

# 启动服务
docker start blog-rpc blog-api admin-api ve-blog-naive ve-admin-element

# 重启服务
docker restart blog-rpc blog-api admin-api ve-blog-naive ve-admin-element

# 删除容器
docker rm -f blog-rpc blog-api admin-api ve-blog-naive ve-admin-element

# 查看日志
docker logs -f blog-api
```

### 更新服务

```bash
# 拉取最新镜像
docker pull ghcr.io/ve-weiyi/blog-api:latest

# 停止并删除旧容器
docker stop blog-api && docker rm blog-api

# 重新运行容器
docker run -d --name blog-api ...
```

## 六、注意事项

### 配置说明

- **Nacos 配置**：需要根据实际情况修改 Nacos 地址、用户名、密码等参数
- **端口映射**：确保服务器防火墙已开放相应端口
- **数据持久化**：使用 `-v` 参数挂载数据卷，避免数据丢失
- **自动重启**：使用 `--restart always` 确保服务异常退出后自动重启

### 安全建议

- ✅ 修改默认密码和配置
- ✅ 配置防火墙规则，仅开放必要端口
- ✅ 使用 Nginx 反向代理，不直接暴露服务端口
- ✅ 启用 HTTPS 加密传输
- ✅ 定期备份数据和配置文件

### 故障排查

**服务无法启动**

```bash
# 查看容器日志
docker logs <container_name>

# 检查端口占用
netstat -tunlp | grep <port>

# 检查容器状态
docker inspect <container_name>
```

**无法访问服务**

- 检查防火墙规则
- 检查服务是否正常运行
- 检查端口映射是否正确
- 检查 Nacos 配置是否正确

## 下一步

完成服务部署后，建议继续配置：

- [Nginx 反向代理配置](生产部署（2）Nginx配置.md)
- [COM_域名访问配置.md](生产部署（3）域名配置.md)
- [HTTPS HTTPS配置](生产部署（4）HTTPS配置.md)
